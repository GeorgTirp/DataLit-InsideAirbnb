<!DOCTYPE html>

<html :class="{'dark': darkMode === 'dark' || (darkMode === 'system' &amp;&amp; window.matchMedia('(prefers-color-scheme: dark)').matches)}" class="scroll-smooth" data-content_root="./" lang="en" x-data="{ darkMode: localStorage.getItem('darkMode') || localStorage.setItem('darkMode', 'system'), activeSection: '' }" x-init="$watch('darkMode', val =&gt; localStorage.setItem('darkMode', val))">
<head>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta charset="utf-8"/>
<meta content="white" media="(prefers-color-scheme: light)" name="theme-color"/>
<meta content="black" media="(prefers-color-scheme: dark)" name="theme-color"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Preprocessing | InsideAirBnB  documentation</title>
<meta content="Preprocessing | InsideAirBnB  documentation" property="og:title"/>
<meta content="Preprocessing | InsideAirBnB  documentation" name="twitter:title"/>
<link href="_static/pygments.css?v=e72c8e07" rel="stylesheet" type="text/css"/>
<link href="_static/theme.css?v=42baaae4" rel="stylesheet" type="text/css"/>
<link href="search.html" rel="search" title="Search"/>
<link href="genindex.html" rel="index" title="Index"/>
<link href="Models.html" rel="next" title="Models"/>
<link href="Data.html" rel="prev" title="Data"/>
<script>
    <!-- Prevent Flash of wrong theme -->
      const userPreference = localStorage.getItem('darkMode');
      let mode;
      if (userPreference === 'dark' || window.matchMedia('(prefers-color-scheme: dark)').matches) {
        mode = 'dark';
        document.documentElement.classList.add('dark');
      } else {
        mode = 'light';
      }
      if (!userPreference) {localStorage.setItem('darkMode', mode)}
    </script>
</head>
<body :class="{ 'overflow-hidden': showSidebar }" class="min-h-screen font-sans antialiased bg-background text-foreground" x-data="{ showSidebar: false, showScrollTop: false }">
<div @click.self="showSidebar = false" class="fixed inset-0 z-50 overflow-hidden bg-background/80 backdrop-blur-sm md:hidden" x-cloak="" x-show="showSidebar"></div><div class="relative flex flex-col min-h-screen" id="page"><a class="absolute top-0 left-0 z-[100] block bg-background p-4 text-xl transition -translate-x-full opacity-0 focus:translate-x-0 focus:opacity-100" href="#content">
      Skip to content
    </a><header class="sticky top-0 z-40 w-full border-b shadow-sm border-border supports-backdrop-blur:bg-background/60 bg-background/95 backdrop-blur"><div class="container flex items-center h-14">
<div class="hidden mr-4 md:flex">
<a class="flex items-center mr-6" href="index.html">
<img alt="Logo" class="mr-2 dark:invert" height="24" src="_static/logo.png" width="24"/><span class="hidden font-bold sm:inline-block text-clip whitespace-nowrap">InsideAirBnB  documentation</span>
</a></div><button @click="showSidebar = true" class="inline-flex items-center justify-center h-10 px-0 py-2 mr-2 text-base font-medium transition-colors rounded-md hover:text-accent-foreground hover:bg-transparent md:hidden" type="button">
<svg aria-hidden="true" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M152.587 825.087q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440Zm0-203.587q-19.152 0-32.326-13.174T107.087 576q0-19.152 13.174-32.326t32.326-13.174h320q19.152 0 32.326 13.174T518.087 576q0 19.152-13.174 32.326T472.587 621.5h-320Zm0-203.587q-19.152 0-32.326-13.174t-13.174-32.326q0-19.152 13.174-32.326t32.326-13.174h440q19.152 0 32.326 13.174t13.174 32.326q0 19.152-13.174 32.326t-32.326 13.174h-440ZM708.913 576l112.174 112.174q12.674 12.674 12.674 31.826t-12.674 31.826Q808.413 764.5 789.261 764.5t-31.826-12.674l-144-144Q600 594.391 600 576t13.435-31.826l144-144q12.674-12.674 31.826-12.674t31.826 12.674q12.674 12.674 12.674 31.826t-12.674 31.826L708.913 576Z"></path>
</svg>
<span class="sr-only">Toggle navigation menu</span>
</button>
<div class="flex items-center justify-between flex-1 space-x-2 sm:space-x-4 md:justify-end">
<div class="flex-1 w-full md:w-auto md:flex-none"><form @keydown.k.window.meta="$refs.search.focus()" action="search.html" class="relative flex items-center group" id="searchbox" method="get">
<input aria-label="Search the docs" class="inline-flex items-center font-medium transition-colors bg-transparent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background border border-input hover:bg-accent focus:bg-accent hover:text-accent-foreground focus:text-accent-foreground hover:placeholder-accent-foreground py-2 px-4 relative h-9 w-full justify-start rounded-[0.5rem] text-sm text-muted-foreground sm:pr-12 md:w-40 lg:w-64" id="search-input" name="q" placeholder="Search ..." type="search" x-ref="search"/>
<kbd class="pointer-events-none absolute right-1.5 top-2 hidden h-5 select-none text-muted-foreground items-center gap-1 rounded border border-border bg-muted px-1.5 font-mono text-[10px] font-medium opacity-100 sm:flex group-hover:bg-accent group-hover:text-accent-foreground">
<span class="text-xs">⌘</span>
    K
  </kbd>
</form>
</div>
<nav class="flex items-center space-x-1">
<button @click="darkMode = darkMode === 'light' ? 'dark' : 'light'" aria-label="Color theme switcher" class="relative inline-flex items-center justify-center px-0 text-sm font-medium transition-colors rounded-md hover:bg-accent hover:text-accent-foreground h-9 w-9" type="button">
<svg class="absolute transition-all scale-100 rotate-0 dark:-rotate-90 dark:scale-0" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 685q45.456 0 77.228-31.772Q589 621.456 589 576q0-45.456-31.772-77.228Q525.456 467 480 467q-45.456 0-77.228 31.772Q371 530.544 371 576q0 45.456 31.772 77.228Q434.544 685 480 685Zm0 91q-83 0-141.5-58.5T280 576q0-83 58.5-141.5T480 376q83 0 141.5 58.5T680 576q0 83-58.5 141.5T480 776ZM80 621.5q-19.152 0-32.326-13.174T34.5 576q0-19.152 13.174-32.326T80 530.5h80q19.152 0 32.326 13.174T205.5 576q0 19.152-13.174 32.326T160 621.5H80Zm720 0q-19.152 0-32.326-13.174T754.5 576q0-19.152 13.174-32.326T800 530.5h80q19.152 0 32.326 13.174T925.5 576q0 19.152-13.174 32.326T880 621.5h-80Zm-320-320q-19.152 0-32.326-13.174T434.5 256v-80q0-19.152 13.174-32.326T480 130.5q19.152 0 32.326 13.174T525.5 176v80q0 19.152-13.174 32.326T480 301.5Zm0 720q-19.152 0-32.326-13.17Q434.5 995.152 434.5 976v-80q0-19.152 13.174-32.326T480 850.5q19.152 0 32.326 13.174T525.5 896v80q0 19.152-13.174 32.33-13.174 13.17-32.326 13.17ZM222.174 382.065l-43-42Q165.5 327.391 166 308.239t13.174-33.065q13.435-13.674 32.587-13.674t32.065 13.674l42.239 43q12.674 13.435 12.555 31.706-.12 18.272-12.555 31.946-12.674 13.674-31.445 13.413-18.772-.261-32.446-13.174Zm494 494.761-42.239-43q-12.674-13.435-12.674-32.087t12.674-31.565Q686.609 756.5 705.38 757q18.772.5 32.446 13.174l43 41.761Q794.5 824.609 794 843.761t-13.174 33.065Q767.391 890.5 748.239 890.5t-32.065-13.674Zm-42-494.761Q660.5 369.391 661 350.62q.5-18.772 13.174-32.446l41.761-43Q728.609 261.5 747.761 262t33.065 13.174q13.674 13.435 13.674 32.587t-13.674 32.065l-43 42.239q-13.435 12.674-31.706 12.555-18.272-.12-31.946-12.555Zm-495 494.761Q165.5 863.391 165.5 844.239t13.674-32.065l43-42.239q13.435-12.674 32.087-12.674t31.565 12.674Q299.5 782.609 299 801.38q-.5 18.772-13.174 32.446l-41.761 43Q231.391 890.5 212.239 890t-33.065-13.174ZM480 576Z"></path>
</svg>
<svg class="absolute transition-all scale-0 rotate-90 dark:rotate-0 dark:scale-100" fill="currentColor" height="24" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 936q-151 0-255.5-104.5T120 576q0-138 90-239.5T440 218q25-3 39 18t-1 44q-17 26-25.5 55t-8.5 61q0 90 63 153t153 63q31 0 61.5-9t54.5-25q21-14 43-1.5t19 39.5q-14 138-117.5 229T480 936Zm0-80q88 0 158-48.5T740 681q-20 5-40 8t-40 3q-123 0-209.5-86.5T364 396q0-20 3-40t8-40q-78 32-126.5 102T200 576q0 116 82 198t198 82Zm-10-270Z"></path>
</svg>
</button>
</nav>
</div>
</div>
</header>
<div class="flex-1"><div class="container flex-1 items-start md:grid md:grid-cols-[220px_minmax(0,1fr)] md:gap-6 lg:grid-cols-[240px_minmax(0,1fr)] lg:gap-10"><aside :aria-hidden="!showSidebar" :class="{ 'translate-x-0': showSidebar }" class="fixed inset-y-0 left-0 md:top-14 z-50 md:z-30 bg-background md:bg-transparent transition-all duration-100 -translate-x-full md:translate-x-0 ml-0 p-6 md:p-0 md:-ml-2 md:h-[calc(100vh-3.5rem)] w-5/6 md:w-full shrink-0 overflow-y-auto border-r border-border md:sticky" id="left-sidebar">
<a class="!justify-start text-sm md:!hidden bg-background" href="index.html">
<img alt="Logo" class="mr-2 dark:invert" height="16" src="_static/logo.png" width="16"/><span class="font-bold text-clip whitespace-nowrap">InsideAirBnB  documentation</span>
</a>
<div class="relative overflow-hidden md:overflow-auto my-4 md:my-0 h-[calc(100vh-8rem)] md:h-auto">
<div class="overflow-y-auto h-full w-full relative pr-6"><nav class="table w-full min-w-full my-6 lg:my-8">
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Data.html">Data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="Models.html">Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="Results.html">Results</a></li>
</ul>
</nav>
</div>
</div>
<button @click="showSidebar = false" class="absolute md:hidden right-4 top-4 rounded-sm opacity-70 transition-opacity hover:opacity-100" type="button">
<svg class="h-4 w-4" fill="currentColor" height="24" stroke="none" viewbox="0 96 960 960" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M480 632 284 828q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 28-11t28 11q11 11 11 28t-11 28L536 576l196 196q11 11 11 28t-11 28q-11 11-28 11t-28-11L480 632Z"></path>
</svg>
</button>
</aside>
<main class="relative py-6 lg:gap-10 lg:py-8 xl:grid xl:grid-cols-[1fr_300px]">
<div class="w-full min-w-0 mx-auto">
<nav aria-label="breadcrumbs" class="flex items-center mb-4 space-x-1 text-sm text-muted-foreground">
<a class="overflow-hidden text-ellipsis whitespace-nowrap hover:text-foreground" href="index.html">
<span class="hidden md:inline">InsideAirBnB  documentation</span>
<svg aria-label="Home" class="md:hidden" fill="currentColor" height="18" stroke="none" viewbox="0 96 960 960" width="18" xmlns="http://www.w3.org/2000/svg">
<path d="M240 856h120V616h240v240h120V496L480 316 240 496v360Zm-80 80V456l320-240 320 240v480H520V696h-80v240H160Zm320-350Z"></path>
</svg>
</a>
<div class="mr-1">/</div><span aria-current="page" class="font-medium text-foreground overflow-hidden text-ellipsis whitespace-nowrap">Preprocessing</span>
</nav>
<div id="content" role="main">
<section id="preprocessing">
<h1>Preprocessing<a class="headerlink" href="#preprocessing" title="Link to this heading">¶</a></h1>
<p>The data was automatically downloaded from the InsideAirBnB website:
<a class="reference external" href="http://insideairbnb.com/get-the-data.html">InsideAirBnB</a></p>
<p>Then the data was aggregated into a single csv file for each city by the following script:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">preprocessing.py</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><code><span id="line-1"><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="line-2"><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="line-3"><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
</span><span id="line-4"><span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="line-5"><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span> 
</span><span id="line-6"><span class="kn">import</span><span class="w"> </span><span class="nn">transformers</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tf</span>
</span><span id="line-7"><span class="kn">from</span><span class="w"> </span><span class="nn">torch.utils.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataLoader</span>
</span><span id="line-8"><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
</span><span id="line-9"><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="line-10"><span class="kn">import</span><span class="w"> </span><span class="nn">sklearn</span>
</span><span id="line-11"><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.decomposition</span><span class="w"> </span><span class="kn">import</span> <span class="n">PCA</span>
</span><span id="line-12"><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span> 
</span><span id="line-13"><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
</span><span id="line-14"><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span>
</span><span id="line-15"><span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
</span><span id="line-16"><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.transforms</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">transforms</span>
</span><span id="line-17"><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">models</span>
</span><span id="line-18"><span class="kn">from</span><span class="w"> </span><span class="nn">torchvision.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ResNet50_Weights</span>
</span><span id="line-19"><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
</span><span id="line-20"><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="line-21"><span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
</span><span id="line-22"><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
</span><span id="line-23"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">'</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">'</span><span class="p">)</span>
</span><span id="line-24"><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span> 
</span><span id="line-25"><span class="kn">import</span><span class="w"> </span><span class="nn">gc</span>
</span><span id="line-26"><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</span><span id="line-27"><span class="kn">import</span><span class="w"> </span><span class="nn">aiohttp</span>
</span><span id="line-28"><span class="c1">#sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))</span>
</span><span id="line-29"><span class="c1">#from models.add_custom_features import AddCustomFeatures</span>
</span><span id="line-30">
</span><span id="line-31">
</span><span id="line-32"><span class="k">class</span><span class="w"> </span><span class="nc">ImageDownloader</span><span class="p">:</span>
</span><span id="line-33">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cities</span><span class="p">,</span> <span class="n">all_cities_listings</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
</span><span id="line-34">        <span class="bp">self</span><span class="o">.</span><span class="n">cities</span> <span class="o">=</span> <span class="n">cities</span>
</span><span id="line-35">        <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span>
</span><span id="line-36">        <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
</span><span id="line-37">        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>  <span class="c1"># Process images in batches</span>
</span><span id="line-38">
</span><span id="line-39">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">image_url</span><span class="p">):</span>
</span><span id="line-40"><span class="w">        </span><span class="sd">"""Asynchronously fetch an image from a URL"""</span>
</span><span id="line-41">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>  <span class="c1"># Handle NaN URLs</span>
</span><span id="line-42">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="line-43">
</span><span id="line-44">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-45">            <span class="k">async</span> <span class="k">with</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span> <span class="k">as</span> <span class="n">response</span><span class="p">:</span>
</span><span id="line-46">                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="line-47">                    <span class="k">return</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># Return raw image bytes</span>
</span><span id="line-48">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-49">            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Failed to download </span><span class="si">{</span><span class="n">image_url</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-50">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="line-51">
</span><span id="line-52">    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">download_images_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_urls</span><span class="p">):</span>
</span><span id="line-53"><span class="w">        </span><span class="sd">"""Download images asynchronously in batches"""</span>
</span><span id="line-54">        <span class="k">async</span> <span class="k">with</span> <span class="n">aiohttp</span><span class="o">.</span><span class="n">ClientSession</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
</span><span id="line-55">            <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_image</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">image_urls</span><span class="p">]</span>
</span><span id="line-56">            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>  <span class="c1"># Fetch all images in parallel</span>
</span><span id="line-57">
</span><span id="line-58">    <span class="k">def</span><span class="w"> </span><span class="nf">process_and_save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img_bytes</span><span class="p">,</span> <span class="n">image_path</span><span class="p">):</span>
</span><span id="line-59"><span class="w">        </span><span class="sd">"""Process and save an image"""</span>
</span><span id="line-60">        <span class="k">try</span><span class="p">:</span>
</span><span id="line-61">            <span class="k">if</span> <span class="n">img_bytes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-62">                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">)</span>  <span class="c1"># Placeholder image</span>
</span><span id="line-63">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-64">                <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">img_bytes</span><span class="p">))</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_size</span><span class="p">)</span>
</span><span id="line-65">                <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">"RGB"</span><span class="p">:</span>
</span><span id="line-66">                    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">)</span>
</span><span id="line-67">
</span><span id="line-68">            <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">image_path</span><span class="p">,</span> <span class="s2">"JPEG"</span><span class="p">)</span>
</span><span id="line-69">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-70">            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Error processing image </span><span class="si">{</span><span class="n">image_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-71">
</span><span id="line-72">    <span class="k">def</span><span class="w"> </span><span class="nf">download_images_and_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-73">                                 <span class="n">image_url_col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">'host_picture_url'</span><span class="p">,</span> <span class="s1">'picture_url'</span><span class="p">],</span> 
</span><span id="line-74">                                 <span class="n">saving_dir</span><span class="o">=</span><span class="s1">'kaggle/working/preprocessed_data/filtered_dataset_images'</span><span class="p">,</span> 
</span><span id="line-75">                                 <span class="n">process_n_images</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="line-76">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"Initializing image downloading process"</span><span class="p">)</span>
</span><span id="line-77">
</span><span id="line-78">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
</span><span id="line-79">            <span class="k">for</span> <span class="n">image_url_col_name</span> <span class="ow">in</span> <span class="n">image_url_col_names</span><span class="p">:</span>
</span><span id="line-80">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Downloading images from column '</span><span class="si">{</span><span class="n">image_url_col_name</span><span class="si">}</span><span class="s2">' for city '</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="line-81">
</span><span id="line-82">                <span class="n">city_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="s2">"city"</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">]</span>
</span><span id="line-83">                <span class="n">image_urls</span> <span class="o">=</span> <span class="n">city_listings</span><span class="p">[</span><span class="n">image_url_col_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="line-84">
</span><span id="line-85">                <span class="k">if</span> <span class="n">process_n_images</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="line-86">                    <span class="n">image_urls</span> <span class="o">=</span> <span class="n">image_urls</span><span class="p">[:</span><span class="n">process_n_images</span><span class="p">]</span>  <span class="c1"># Limit number of images</span>
</span><span id="line-87">
</span><span id="line-88">                <span class="n">image_saving_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saving_dir</span><span class="p">,</span> <span class="n">city</span><span class="p">,</span> <span class="n">image_url_col_name</span><span class="p">)</span>
</span><span id="line-89">                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">image_saving_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-90">
</span><span id="line-91">                <span class="c1"># Process images in batches</span>
</span><span id="line-92">                <span class="k">for</span> <span class="n">batch_start</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_urls</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">):</span>
</span><span id="line-93">                    <span class="n">batch_urls</span> <span class="o">=</span> <span class="n">image_urls</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span> <span class="n">batch_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
</span><span id="line-94">                    
</span><span id="line-95">                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Processing batch </span><span class="si">{</span><span class="n">batch_start</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">, size: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_urls</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-96">
</span><span id="line-97">                    <span class="n">image_bytes_list</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">download_images_async</span><span class="p">(</span><span class="n">batch_urls</span><span class="p">))</span>
</span><span id="line-98">
</span><span id="line-99">                    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="line-100">                        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-101">                            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_and_save_image</span><span class="p">,</span> <span class="n">img_bytes</span><span class="p">,</span> 
</span><span id="line-102">                                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_saving_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"image_</span><span class="si">{</span><span class="n">batch_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="si">}</span><span class="s2">.jpg"</span><span class="p">))</span>
</span><span id="line-103">                            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">img_bytes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">image_bytes_list</span><span class="p">)</span>
</span><span id="line-104">                        <span class="p">]</span>
</span><span id="line-105">                        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">tasks</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">"Processing batch </span><span class="si">{</span><span class="n">batch_start</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">"</span><span class="p">):</span>
</span><span id="line-106">                            <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait for all tasks to complete</span>
</span><span id="line-107">
</span><span id="line-108">                    <span class="c1"># Free up memory after each batch</span>
</span><span id="line-109">                    <span class="k">del</span> <span class="n">image_bytes_list</span>
</span><span id="line-110">                    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="line-111">
</span><span id="line-112">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Finished downloading images for </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">image_url_col_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-113">
</span><span id="line-114">
</span><span id="line-115">
</span><span id="line-116"><span class="n">DEBUG_MODE</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="line-117">
</span><span id="line-118"><span class="k">class</span><span class="w"> </span><span class="nc">InsideAirbnbDataset</span><span class="p">:</span>
</span><span id="line-119"><span class="w">    </span><span class="sd">"""</span>
</span><span id="line-120"><span class="sd">    A dataset class for processing and handling Airbnb data collected from https://insideairbnb.com/get-the-data/.</span>
</span><span id="line-121"><span class="sd">    Processing multiple cities at once is supported.</span>
</span><span id="line-122"><span class="sd">    Data can either be read in from raw data files or from already (via this script) preprocessed data files.</span>
</span><span id="line-123">
</span><span id="line-124">
</span><span id="line-125"><span class="sd">    Important Attributes:</span>
</span><span id="line-126"><span class="sd">        raw_data_dict (Dict): If files are read in from raw data directory, raw_data_dict contains them.</span>
</span><span id="line-127"><span class="sd">        all_cities_listings (pd.DataFrame): Pandas Dataframe containing all listings of respective cities.</span>
</span><span id="line-128"><span class="sd">    </span>
</span><span id="line-129"><span class="sd">    """</span>
</span><span id="line-130">    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="line-131">            <span class="bp">self</span><span class="p">,</span>
</span><span id="line-132">            <span class="n">raw_data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"/kaggle/input/berlin-amsterdam/raw_data"</span><span class="p">,</span>
</span><span id="line-133">            <span class="n">process_all_cities</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="line-134">            <span class="n">cities_to_process</span><span class="p">:</span> <span class="nb">list</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">"berlin"</span><span class="p">],</span>
</span><span id="line-135">            <span class="n">read_from_raw</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="line-136">            <span class="n">preprocessed_data_dir</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="s1">'preprocessed_data'</span><span class="p">,</span>
</span><span id="line-137">            <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'single_city_listing.csv'</span><span class="p">):</span>
</span><span id="line-138">        
</span><span id="line-139">        <span class="bp">self</span><span class="o">.</span><span class="n">process_all_cities</span> <span class="o">=</span> <span class="n">process_all_cities</span>
</span><span id="line-140">        <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span> <span class="o">=</span> <span class="n">cities_to_process</span>
</span><span id="line-141">        
</span><span id="line-142">        <span class="c1"># determine whether data is read in from raw data files or already preprocessed (via this script) data files</span>
</span><span id="line-143">        <span class="k">if</span> <span class="n">read_from_raw</span><span class="p">:</span>
</span><span id="line-144">            <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">=</span> <span class="n">raw_data_dir</span>
</span><span id="line-145">    
</span><span id="line-146">            <span class="c1"># read in raw data from raw data directory in repository</span>
</span><span id="line-147">            <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_data_from_files</span><span class="p">()</span>
</span><span id="line-148">    
</span><span id="line-149">            <span class="c1"># integrate the reviews from reviews df into the listings df for each city in the raw_data_dict</span>
</span><span id="line-150">            <span class="bp">self</span><span class="o">.</span><span class="n">_integrate_reviews_into_listings</span><span class="p">()</span>
</span><span id="line-151">    
</span><span id="line-152">            <span class="c1"># aggregate all listings dfs from each city and store in one all_cities_listings df</span>
</span><span id="line-153">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_city_listings_into_one_df</span><span class="p">()</span>
</span><span id="line-154">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-155">            <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_data_dir</span> <span class="o">=</span> <span class="n">preprocessed_data_dir</span>
</span><span id="line-156">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_preprocessed_listings</span><span class="p">(</span><span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">)</span>
</span><span id="line-157">        
</span><span id="line-158">    
</span><span id="line-159">    <span class="k">def</span><span class="w"> </span><span class="nf">_read_data_from_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="line-160">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"reading in data from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-161">        <span class="n">cities_in_raw_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span><span class="p">)</span>
</span><span id="line-162">
</span><span id="line-163">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all_cities</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">cities_in_raw_data_dir</span><span class="p">):</span>
</span><span id="line-164">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"not all requested citys are in directory"</span><span class="p">)</span>
</span><span id="line-165">        
</span><span id="line-166">        <span class="n">raw_data_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-167">
</span><span id="line-168">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all_cities</span><span class="p">:</span>
</span><span id="line-169">            <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span> <span class="o">=</span> <span class="n">cities_in_raw_data_dir</span>
</span><span id="line-170">
</span><span id="line-171">        <span class="bp">self</span><span class="o">.</span><span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span>
</span><span id="line-172">        
</span><span id="line-173">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span><span class="p">:</span>
</span><span id="line-174">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"collecting data for city: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-175">            <span class="n">raw_data_dict</span><span class="p">[</span><span class="n">city</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="line-176">            <span class="n">city_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">city</span>
</span><span id="line-177">            <span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">city_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
</span><span id="line-178">
</span><span id="line-179">            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_names</span><span class="p">:</span>
</span><span id="line-180">                <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.csv'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.geojson'</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.csv.gz'</span><span class="p">):</span>
</span><span id="line-181">                    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">city_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
</span><span id="line-182">            
</span><span id="line-183">                    <span class="c1"># Read the file into a DataFrame</span>
</span><span id="line-184">                    <span class="k">if</span> <span class="n">file_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">'.geojson'</span><span class="p">):</span>
</span><span id="line-185">                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># Adjust based on the specific geojson handling</span>
</span><span id="line-186">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-187">                        <span class="n">file_name_core</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">"."</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-188">
</span><span id="line-189">                        <span class="k">if</span> <span class="n">file_name_core</span> <span class="o">==</span> <span class="s2">"reviews"</span><span class="p">:</span>
</span><span id="line-190">                            <span class="n">index_col</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="line-191">                        <span class="k">else</span><span class="p">:</span>
</span><span id="line-192">                            <span class="n">index_col</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-193">                            
</span><span id="line-194">                        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">index_col</span><span class="p">)</span>
</span><span id="line-195">
</span><span id="line-196">                        <span class="c1"># filter out all listings which do not have price available</span>
</span><span id="line-197">                        <span class="k">if</span> <span class="n">file_name_core</span> <span class="o">==</span> <span class="s2">"listings"</span><span class="p">:</span>
</span><span id="line-198">                            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">"price"</span><span class="p">]</span><span class="o">.</span><span class="n">notna</span><span class="p">()]</span>
</span><span id="line-199">
</span><span id="line-200">                    <span class="n">raw_data_dict</span><span class="p">[</span><span class="n">city</span><span class="p">][</span><span class="n">file_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span>
</span><span id="line-201">
</span><span id="line-202">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"collecting data process done"</span><span class="p">)</span>
</span><span id="line-203">
</span><span id="line-204">        <span class="k">return</span> <span class="n">raw_data_dict</span>
</span><span id="line-205">
</span><span id="line-206">    <span class="k">def</span><span class="w"> </span><span class="nf">_integrate_reviews_into_listings</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-207">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"initializing reviews collection process and integration into city listings"</span><span class="p">)</span>
</span><span id="line-208">        
</span><span id="line-209">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
</span><span id="line-210">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"current city: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-211">            <span class="n">city_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dict</span><span class="p">[</span><span class="n">city</span><span class="p">][</span><span class="s2">"listings.csv"</span><span class="p">]</span>
</span><span id="line-212">            <span class="n">city_reviews</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dict</span><span class="p">[</span><span class="n">city</span><span class="p">][</span><span class="s2">"reviews.csv"</span><span class="p">]</span>       
</span><span id="line-213">            <span class="c1">#city_calendar = self.raw_data_dict[city]["calendar.csv"] </span>
</span><span id="line-214">
</span><span id="line-215">            <span class="n">city_listings_indices</span> <span class="o">=</span> <span class="n">city_listings</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="line-216">            <span class="n">city_listings</span><span class="p">[</span><span class="s2">"comments"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">city_listings</span><span class="p">))]</span>
</span><span id="line-217">
</span><span id="line-218">            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">city_listings_indices</span><span class="p">:</span>
</span><span id="line-219">                <span class="n">city_index_reviews</span> <span class="o">=</span> <span class="n">city_reviews</span><span class="p">[</span><span class="n">city_reviews</span><span class="p">[</span><span class="s2">"listing_id"</span><span class="p">]</span> <span class="o">==</span> <span class="n">index</span><span class="p">]</span>
</span><span id="line-220">                <span class="n">comments</span> <span class="o">=</span> <span class="n">city_index_reviews</span><span class="p">[</span><span class="s2">"comments"</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="line-221">
</span><span id="line-222">                <span class="n">comments_with_newline</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-223">                <span class="k">for</span> <span class="n">comment</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
</span><span id="line-224">                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span> <span class="c1">#if it is nan, as nan are float values</span>
</span><span id="line-225">                        <span class="n">comment</span> <span class="o">=</span> <span class="s2">""</span>
</span><span id="line-226">                    <span class="n">comment_transformed</span> <span class="o">=</span> <span class="n">comment</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'&lt;br/&gt;'</span><span class="p">,</span> <span class="s1">'</span><span class="se">\n</span><span class="s1">'</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
</span><span id="line-227">                    <span class="n">comments_with_newline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comment_transformed</span><span class="p">)</span>
</span><span id="line-228">
</span><span id="line-229">                <span class="n">city_listings</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">'comments'</span><span class="p">]</span> <span class="o">=</span> <span class="n">comments_with_newline</span>
</span><span id="line-230">        
</span><span id="line-231">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"integration of reviews into cites listings done"</span><span class="p">)</span>
</span><span id="line-232">
</span><span id="line-233">    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_city_listings_into_one_df</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span> 
</span><span id="line-234">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"initializing aggregation of regional listings into one dataframe"</span><span class="p">)</span>
</span><span id="line-235">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-236">
</span><span id="line-237">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
</span><span id="line-238">            <span class="n">city_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_data_dict</span><span class="p">[</span><span class="n">city</span><span class="p">][</span><span class="s2">"listings.csv"</span><span class="p">]</span>
</span><span id="line-239">            <span class="n">city_listings</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">'city'</span><span class="p">,</span> <span class="n">city</span><span class="p">)</span>
</span><span id="line-240">            <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">city_listings</span><span class="p">)</span>
</span><span id="line-241">
</span><span id="line-242">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_cities_listings</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-243">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"aggregation done"</span><span class="p">)</span>
</span><span id="line-244">        <span class="k">return</span> <span class="n">all_cities_listings</span>
</span><span id="line-245">
</span><span id="line-246">    <span class="k">def</span><span class="w"> </span><span class="nf">filter_listings_and_impute_nan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="line-247">                                       <span class="n">meta_data_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-248">                                           <span class="s1">'listing_url'</span><span class="p">,</span> 
</span><span id="line-249">                                           <span class="s1">'host_location'</span><span class="p">,</span> 
</span><span id="line-250">                                           <span class="s1">'scrape_id'</span><span class="p">,</span> 
</span><span id="line-251">                                           <span class="s1">'last_scraped'</span><span class="p">,</span> 
</span><span id="line-252">                                           <span class="s1">'source'</span><span class="p">,</span>  
</span><span id="line-253">                                           <span class="s1">'host_id'</span><span class="p">,</span> 
</span><span id="line-254">                                           <span class="s1">'host_url'</span><span class="p">,</span> 
</span><span id="line-255">                                           <span class="s1">'host_name'</span><span class="p">,</span> 
</span><span id="line-256">                                           <span class="s1">'host_neighbourhood'</span><span class="p">,</span>
</span><span id="line-257">                                           <span class="s1">'host_thumbnail_url'</span><span class="p">,</span> 
</span><span id="line-258">                                           <span class="s1">'host_verifications'</span><span class="p">,</span> 
</span><span id="line-259">                                           <span class="s1">'neighbourhood'</span><span class="p">,</span> 
</span><span id="line-260">                                           <span class="s1">'neighbourhood_group_cleansed'</span><span class="p">,</span> 
</span><span id="line-261">                                           <span class="s1">'calendar_last_scraped'</span><span class="p">,</span> 
</span><span id="line-262">                                           <span class="s1">'license'</span>
</span><span id="line-263">                                       <span class="p">],</span>
</span><span id="line-264">                                       <span class="n">nan_columns</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'calendar_updated'</span><span class="p">],</span>
</span><span id="line-265">                                       <span class="n">include_only_reviewed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-266">        
</span><span id="line-267">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span>
</span><span id="line-268">        <span class="c1">#filter the NaN columns (here are no entries)</span>
</span><span id="line-269">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">nan_columns</span><span class="p">)</span>
</span><span id="line-270">        
</span><span id="line-271">        <span class="c1">#filter the meta_data columns (these columns are not used for prediction)</span>
</span><span id="line-272">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="n">meta_data_columns</span><span class="p">)</span>
</span><span id="line-273">    
</span><span id="line-274">
</span><span id="line-275">        <span class="c1">#categorical NaN:</span>
</span><span id="line-276">        <span class="c1">#  'host_response_time' --&gt; extra NaN category</span>
</span><span id="line-277">        <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">'host_response_time'</span><span class="p">:</span> <span class="s1">'not available'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-278">    
</span><span id="line-279">        <span class="c1">#  'host_is_superhost'  --&gt; False</span>
</span><span id="line-280">        <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">'host_is_superhost'</span><span class="p">:</span> <span class="s1">'f'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-281">        
</span><span id="line-282">        <span class="c1">#  'has_availability'   --&gt; False</span>
</span><span id="line-283">        <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="s1">'has_availability'</span><span class="p">:</span> <span class="s1">'f'</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-284">
</span><span id="line-285">        
</span><span id="line-286">        <span class="c1">#numerical NaN:</span>
</span><span id="line-287">        <span class="c1">#  'host_response_rate'    --&gt; mean/median</span>
</span><span id="line-288">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="line-289">            <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s1">'%'</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">s</span><span class="p">,</span> 
</span><span id="line-290">            <span class="n">na_action</span> <span class="o">=</span> <span class="s1">'ignore'</span>
</span><span id="line-291">        <span class="p">)</span>
</span><span id="line-292">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">'%'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">)</span>
</span><span id="line-293">        <span class="n">median_value</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="line-294">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_response_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">median_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-295">
</span><span id="line-296">        <span class="c1">#  'host_acceptance_rate'  --&gt; mean/median</span>
</span><span id="line-297">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
</span><span id="line-298">            <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="n">s</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="s1">'%'</span><span class="p">)</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span> <span class="k">else</span> <span class="n">s</span><span class="p">,</span> 
</span><span id="line-299">            <span class="n">na_action</span> <span class="o">=</span> <span class="s1">'ignore'</span>
</span><span id="line-300">        <span class="p">)</span>
</span><span id="line-301">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">'%'</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">'float'</span><span class="p">)</span>
</span><span id="line-302">        <span class="n">median_value</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="line-303">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'host_acceptance_rate'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">median_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-304">
</span><span id="line-305">        <span class="c1">#  'bathrooms'        --&gt; mean/median</span>
</span><span id="line-306">        <span class="n">median_value</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'bathrooms'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="line-307">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'bathrooms'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">median_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-308">
</span><span id="line-309">        <span class="c1">#  'bedrooms'         --&gt; mean/median</span>
</span><span id="line-310">        <span class="n">median_value</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'bedrooms'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="line-311">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'bedrooms'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">median_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-312">
</span><span id="line-313">        <span class="c1">#  'beds'         --&gt; mean/median</span>
</span><span id="line-314">        <span class="n">median_value</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'beds'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
</span><span id="line-315">        <span class="n">all_cities_listings</span><span class="p">[</span><span class="s1">'beds'</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">median_value</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-316">
</span><span id="line-317">        <span class="c1">#  'first_review'     --&gt; leave out listings without reviews (only include listings which include reviews which indicates that listings are booked and price is valid)</span>
</span><span id="line-318">        <span class="c1">#   .....</span>
</span><span id="line-319">        <span class="c1">#  'reviews_per_mon'  --&gt; leave out listings without reviews (only include listings which include reviews which indicates that listings are booked and price is valid)</span>
</span><span id="line-320">        <span class="n">review_columns</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-321">                <span class="s1">'first_review'</span><span class="p">,</span> 
</span><span id="line-322">                <span class="s1">'review_scores_rating'</span><span class="p">,</span> 
</span><span id="line-323">                <span class="s1">'review_scores_accuracy'</span><span class="p">,</span> 
</span><span id="line-324">                <span class="s1">'review_scores_cleanliness'</span><span class="p">,</span> 
</span><span id="line-325">                <span class="s1">'review_scores_checkin'</span><span class="p">,</span>
</span><span id="line-326">                <span class="s1">'review_scores_communication'</span><span class="p">,</span> 
</span><span id="line-327">                <span class="s1">'review_scores_location'</span><span class="p">,</span> 
</span><span id="line-328">                <span class="s1">'review_scores_value'</span><span class="p">,</span> 
</span><span id="line-329">                <span class="s1">'reviews_per_month'</span>
</span><span id="line-330">            <span class="p">]</span>
</span><span id="line-331">        <span class="c1">#if include_only_reviewed:</span>
</span><span id="line-332">        <span class="c1">#    all_cities_listings = all_cities_listings[all_cities_listings['first_review'].notna()]</span>
</span><span id="line-333">        <span class="c1">#    for review_col in review_columns:</span>
</span><span id="line-334">        <span class="c1">#        assert not all_cities_listings[review_col].isna().any()</span>
</span><span id="line-335">        <span class="c1">#else:</span>
</span><span id="line-336">        <span class="c1">#    # since I could not think of an sensible imputation strategy</span>
</span><span id="line-337">        <span class="c1">#    all_cities_listings.drop(columns = review_columns)</span>
</span><span id="line-338">        <span class="c1">#</span>
</span><span id="line-339">        <span class="c1">#NLP NaN:</span>
</span><span id="line-340">        <span class="c1">#  'name'                   --&gt; embedding of empty string ""</span>
</span><span id="line-341">        <span class="c1">#  'description'            --&gt; embedding of empty string ""</span>
</span><span id="line-342">        <span class="c1">#  'neighborhood_overview'  --&gt; embedding of empty string ""</span>
</span><span id="line-343">        <span class="c1">#  'host_about'             --&gt; embedding of empty string ""</span>
</span><span id="line-344">        <span class="c1"># --&gt; these are handled in the add_nlp_embedding function</span>
</span><span id="line-345">    
</span><span id="line-346">        <span class="c1">#  'comments'             --&gt; embedding of empty string ""</span>
</span><span id="line-347">        <span class="c1"># --&gt; handled in the _integrate_reviews_into_listings function</span>
</span><span id="line-348">
</span><span id="line-349">        <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span>
</span><span id="line-350">        
</span><span id="line-351">    
</span><span id="line-352">    <span class="k">def</span><span class="w"> </span><span class="nf">add_nlp_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-353">                          <span class="n">nlp_col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'neighborhood_overview'</span><span class="p">,</span> <span class="s1">'host_about'</span><span class="p">,</span> <span class="s1">'amenities'</span><span class="p">,</span><span class="s1">'comments'</span><span class="p">],</span> 
</span><span id="line-354">                          <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-355">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"initializing NLP embedding process, batch size: </span><span class="si">{</span><span class="n">batch_size</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-356">        <span class="n">device</span> <span class="o">=</span> <span class="s1">'cuda'</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">'cpu'</span>
</span><span id="line-357">        <span class="n">model_name</span> <span class="o">=</span> <span class="s1">'distilbert-base-multilingual-cased'</span>
</span><span id="line-358">        <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-359">        <span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">AutoModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_name</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="line-360">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"embeddings are computed using transformer model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> from hugging face"</span><span class="p">)</span>
</span><span id="line-361">        
</span><span id="line-362">        <span class="k">for</span> <span class="n">nlp_col_name</span> <span class="ow">in</span> <span class="n">nlp_col_names</span><span class="p">:</span>
</span><span id="line-363">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"current nlp column: </span><span class="si">{</span><span class="n">nlp_col_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-364">
</span><span id="line-365">            <span class="n">nlp_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">nlp_col_name</span><span class="p">]</span>
</span><span id="line-366">            <span class="n">nlp_col_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-367">
</span><span id="line-368">            <span class="c1"># convert nlp columns to a list </span>
</span><span id="line-369">            <span class="k">if</span> <span class="n">nlp_col_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'name'</span><span class="p">,</span> <span class="s1">'description'</span><span class="p">,</span> <span class="s1">'neighborhood_overview'</span><span class="p">,</span> <span class="s1">'host_about'</span><span class="p">,</span> <span class="s1">'comments'</span><span class="p">]:</span>
</span><span id="line-370">                <span class="n">nlp_col_list</span> <span class="o">=</span> <span class="n">nlp_col</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</span><span id="line-371">            <span class="k">elif</span> <span class="n">nlp_col_name</span> <span class="o">==</span> <span class="s2">"amenities"</span><span class="p">:</span>
</span><span id="line-372">                <span class="k">for</span> <span class="n">amenities_raw_entry</span> <span class="ow">in</span> <span class="n">nlp_col</span><span class="p">:</span>
</span><span id="line-373">                    <span class="n">amenities_collection</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">amenities_raw_entry</span><span class="p">)</span> <span class="c1"># amenities_raw_entry is in json string format</span>
</span><span id="line-374">                    <span class="n">nlp_col_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amenities_collection</span><span class="p">)</span>
</span><span id="line-375">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-376">                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"no procedure found for converting </span><span class="si">{</span><span class="n">nlp_col_name</span><span class="si">}</span><span class="s2"> to list"</span><span class="p">)</span>
</span><span id="line-377">            
</span><span id="line-378">
</span><span id="line-379">            <span class="n">nlp_col_list_embedded</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-380">
</span><span id="line-381">            <span class="n">pooling_approach</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'amenities'</span><span class="p">,</span> <span class="s1">'comments'</span><span class="p">]</span>
</span><span id="line-382">            <span class="c1"># for each entry in nlp column, single embeddings are inferred for amenity_items / single reviews --&gt; then mean pooling</span>
</span><span id="line-383">            <span class="k">if</span> <span class="n">nlp_col_name</span> <span class="ow">in</span> <span class="n">pooling_approach</span><span class="p">:</span>
</span><span id="line-384">                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">nlp_col_list</span><span class="p">)):</span>
</span><span id="line-385">                    <span class="k">if</span> <span class="n">entry</span> <span class="o">==</span> <span class="p">[]:</span>
</span><span id="line-386">                        <span class="n">entry</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="s2">" "</span><span class="p">])</span>
</span><span id="line-387">                        
</span><span id="line-388">                    <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="line-389">                    <span class="n">entry_items_embeddings_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-390">                    
</span><span id="line-391">                    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
</span><span id="line-392">                        <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">"pt"</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="line-393">                        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="line-394">                            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="line-395">                        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="line-396">                        <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="line-397">                        <span class="n">entry_items_embeddings_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
</span><span id="line-398">                    
</span><span id="line-399">                    <span class="n">embeddings_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">entry_items_embeddings_list</span><span class="p">)</span>
</span><span id="line-400">                    <span class="n">mean_pooled_embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">embeddings_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-401">                    <span class="n">nlp_col_list_embedded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_pooled_embedding</span><span class="p">)</span>
</span><span id="line-402">                    
</span><span id="line-403">            <span class="c1"># embeddings are inferred directly for the entries of all other nlp columns</span>
</span><span id="line-404">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-405">                <span class="n">dataloader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">nlp_col_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="line-406">                <span class="n">elements</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="line-407">                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">dataloader</span><span class="p">):</span>
</span><span id="line-408">                    <span class="n">elements</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="line-409">                    <span class="n">inputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s2">"pt"</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
</span><span id="line-410">                    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="line-411">                        <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="line-412">                    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">outputs</span><span class="o">.</span><span class="n">last_hidden_state</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="line-413">                    <span class="n">embeddings</span> <span class="o">=</span> <span class="n">embeddings</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="line-414">                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">embeddings</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">):</span>
</span><span id="line-415">                        <span class="nb">print</span><span class="p">(</span><span class="n">embeddings</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="line-416">                    <span class="n">nlp_col_list_embedded</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">embeddings</span><span class="p">)</span>
</span><span id="line-417">            
</span><span id="line-418">            <span class="n">nlp_col_embedded_name</span> <span class="o">=</span> <span class="n">nlp_col_name</span> <span class="o">+</span> <span class="s1">'_emb'</span>
</span><span id="line-419">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">nlp_col_embedded_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlp_col_list_embedded</span>
</span><span id="line-420">        
</span><span id="line-421">        <span class="nb">print</span><span class="p">(</span><span class="s2">"nlp embedding done"</span><span class="p">)</span>
</span><span id="line-422">    
</span><span id="line-423">    <span class="k">def</span><span class="w"> </span><span class="nf">dimensionality_reduction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-424">                                 <span class="n">col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="line-425">                                    <span class="s1">'name_emb'</span><span class="p">,</span> 
</span><span id="line-426">                                    <span class="s1">'description_emb'</span><span class="p">,</span> 
</span><span id="line-427">                                    <span class="s1">'neighborhood_overview_emb'</span><span class="p">,</span> 
</span><span id="line-428">                                    <span class="s1">'host_about_emb'</span><span class="p">,</span> 
</span><span id="line-429">                                    <span class="s1">'amenities_emb'</span><span class="p">,</span>
</span><span id="line-430">                                    <span class="s1">'comments_emb'</span><span class="p">,</span>
</span><span id="line-431">                                    <span class="s1">'host_picture_emb'</span><span class="p">,</span>
</span><span id="line-432">                                    <span class="s1">'picture_emb'</span>
</span><span id="line-433">                                 <span class="p">],</span>
</span><span id="line-434">                                <span class="n">keep_variance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-435">        
</span><span id="line-436">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"initializing dimensionality reduction"</span><span class="p">)</span>
</span><span id="line-437">            
</span><span id="line-438">        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
</span><span id="line-439">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"current embeddings: </span><span class="si">{</span><span class="n">col_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-440">            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
</span><span id="line-441">            <span class="n">col_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">col</span><span class="p">])</span>
</span><span id="line-442">
</span><span id="line-443">            <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">keep_variance</span><span class="p">,</span> <span class="n">svd_solver</span><span class="o">=</span><span class="s1">'full'</span><span class="p">)</span>
</span><span id="line-444">            <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">col_array</span><span class="p">)</span>
</span><span id="line-445">            <span class="n">dim_red_col_array</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">col_array</span><span class="p">)</span>
</span><span id="line-446">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"used </span><span class="si">{</span><span class="n">pca</span><span class="o">.</span><span class="n">n_components_</span><span class="w"> </span><span class="si">}</span><span class="s2"> components for dim reduction to explain </span><span class="si">{</span><span class="n">keep_variance</span><span class="o">*</span><span class="mi">100</span><span class="si">}</span><span class="s2">% of the data"</span><span class="p">)</span>
</span><span id="line-447">            
</span><span id="line-448">            <span class="n">dim_red_col_name</span> <span class="o">=</span> <span class="n">col_name</span> <span class="o">+</span> <span class="s1">'_dim_red'</span>
</span><span id="line-449">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">dim_red_col_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dim_red_col_array</span><span class="p">)</span>
</span><span id="line-450">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"dimensionality reduction done"</span><span class="p">)</span>
</span><span id="line-451">
</span><span id="line-452">    <span class="k">def</span><span class="w"> </span><span class="nf">download_images_and_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-453">                            <span class="n">image_url_col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'host_picture_url'</span><span class="p">,</span><span class="s1">'picture_url'</span><span class="p">],</span> 
</span><span id="line-454">                            <span class="n">saving_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'kaggle/working/preprocessed_data/filtered_dataset_images'</span><span class="p">,</span>
</span><span id="line-455">                            <span class="n">process_n_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-456">        
</span><span id="line-457">        <span class="n">image_downloader</span> <span class="o">=</span> <span class="n">ImageDownloader</span><span class="p">(</span><span class="n">cities</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">,</span> <span class="n">all_cities_listings</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">)</span>
</span><span id="line-458">        <span class="n">image_downloader</span><span class="o">.</span><span class="n">download_images_and_save</span><span class="p">(</span>
</span><span id="line-459">                            <span class="n">image_url_col_names</span><span class="o">=</span><span class="n">image_url_col_names</span><span class="p">,</span> 
</span><span id="line-460">                            <span class="n">saving_dir</span><span class="o">=</span><span class="n">saving_dir</span><span class="p">,</span> 
</span><span id="line-461">                            <span class="n">process_n_images</span><span class="o">=</span><span class="n">process_n_images</span><span class="p">)</span>
</span><span id="line-462">        
</span><span id="line-463">                
</span><span id="line-464">            
</span><span id="line-465">
</span><span id="line-466">    <span class="k">def</span><span class="w"> </span><span class="nf">add_image_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-467">                            <span class="n">image_url_col_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'host_picture_url'</span><span class="p">,</span><span class="s1">'picture_url'</span><span class="p">],</span> 
</span><span id="line-468">                            <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
</span><span id="line-469">                            <span class="n">read_from_dir</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="line-470">                            <span class="n">read_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">'kaggle/working/preprocessed_data/filtered_dataset_images'</span><span class="p">,</span>
</span><span id="line-471">                            <span class="n">embedd_n_images</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-472">        
</span><span id="line-473">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"initializing image embedding process"</span><span class="p">)</span>
</span><span id="line-474">        
</span><span id="line-475">        <span class="k">for</span> <span class="n">image_url_col_name</span> <span class="ow">in</span> <span class="n">image_url_col_names</span><span class="p">:</span>
</span><span id="line-476">            
</span><span id="line-477">            <span class="k">if</span> <span class="n">read_from_dir</span><span class="p">:</span>
</span><span id="line-478">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"reading images from directory for column '</span><span class="si">{</span><span class="n">image_url_col_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="line-479">                
</span><span id="line-480">                <span class="n">cities_subdirectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">read_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">read_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">))]</span>
</span><span id="line-481">
</span><span id="line-482">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">))</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">cities_subdirectories</span><span class="p">):</span>
</span><span id="line-483">                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"not all cities in need to be processed are in given read directory"</span><span class="p">)</span>
</span><span id="line-484">
</span><span id="line-485">                <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
</span><span id="line-486">                    <span class="n">column_city_subdirectory</span> <span class="o">=</span> <span class="n">read_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">city</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">image_url_col_name</span>
</span><span id="line-487">                    <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">column_city_subdirectory</span><span class="p">),</span> <span class="sa">f</span><span class="s2">"subdirectory </span><span class="si">{</span><span class="n">column_city_subdirectory</span><span class="si">}</span><span class="s2"> does not exist"</span>
</span><span id="line-488">                    <span class="n">image_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">column_city_subdirectory</span><span class="p">)</span>
</span><span id="line-489">                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">)</span>
</span><span id="line-490">
</span><span id="line-491">                    <span class="n">image_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-492">                    <span class="k">for</span> <span class="n">image_file</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
</span><span id="line-493">                        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_city_subdirectory</span><span class="p">,</span> <span class="n">image_file</span><span class="p">))</span>
</span><span id="line-494">                        <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="line-495">
</span><span id="line-496">                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">)</span>
</span><span id="line-497">                    
</span><span id="line-498">            <span class="k">else</span><span class="p">:</span>
</span><span id="line-499">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"downloading images from web for column '</span><span class="si">{</span><span class="n">image_url_col_name</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</span><span id="line-500">                <span class="n">image_url_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">image_url_col_name</span><span class="p">]</span>
</span><span id="line-501">                <span class="n">image_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-502">                <span class="n">no_access_indices</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-503">                <span class="n">image_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="mi">256</span><span class="p">)</span>
</span><span id="line-504">                
</span><span id="line-505">                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">image_url</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">image_url_col</span><span class="p">)):</span>
</span><span id="line-506">                    <span class="k">if</span> <span class="n">embedd_n_images</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="n">embedd_n_images</span><span class="p">:</span>
</span><span id="line-507">                        <span class="k">break</span>
</span><span id="line-508">                    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
</span><span id="line-509">                    
</span><span id="line-510">                    <span class="c1"># NaN values are floats</span>
</span><span id="line-511">                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="line-512">                        <span class="n">no_access_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="line-513">                        <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">,</span> <span class="n">image_size</span><span class="p">))</span>
</span><span id="line-514">                    <span class="k">else</span><span class="p">:</span>
</span><span id="line-515">                        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span>
</span><span id="line-516">                        <span class="c1"># code for successful request is 200</span>
</span><span id="line-517">                        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span id="line-518">                            <span class="k">try</span><span class="p">:</span>
</span><span id="line-519">                                <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image_size</span><span class="p">)</span>
</span><span id="line-520">                                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s2">"RGB"</span><span class="p">:</span>
</span><span id="line-521">                                    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">'RGB'</span><span class="p">)</span>
</span><span id="line-522">                                <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
</span><span id="line-523">                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="line-524">                                <span class="n">no_access_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="line-525">                                <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">,</span> <span class="n">image_size</span><span class="p">))</span>  
</span><span id="line-526">                        <span class="k">else</span><span class="p">:</span>
</span><span id="line-527">                            <span class="n">no_access_indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="line-528">                            <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"RGB"</span><span class="p">,</span> <span class="n">image_size</span><span class="p">))</span>
</span><span id="line-529">                            <span class="c1">#response.raise_for_status()</span>
</span><span id="line-530">        
</span><span id="line-531">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"pictures from rows </span><span class="si">{</span><span class="n">no_access_indices</span><span class="si">}</span><span class="s2"> could not be accessed"</span><span class="p">)</span>
</span><span id="line-532">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"transform images and construct dataloader"</span><span class="p">)</span>
</span><span id="line-533">    
</span><span id="line-534">            <span class="n">normalize</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span>
</span><span id="line-535">                                     <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">])</span>
</span><span id="line-536">            
</span><span id="line-537">            <span class="n">image_transform</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
</span><span id="line-538">                                            <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="line-539">                                            <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
</span><span id="line-540">                                            <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
</span><span id="line-541">                                            <span class="n">normalize</span>
</span><span id="line-542">                                            <span class="p">])</span>
</span><span id="line-543">            <span class="n">tensor_image_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">image_transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">]</span>
</span><span id="line-544">    
</span><span id="line-545">            <span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">tensor_image_list</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
</span><span id="line-546">            
</span><span id="line-547">            <span class="n">resnet</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">ResNet50_Weights</span><span class="o">.</span><span class="n">DEFAULT</span><span class="p">)</span>
</span><span id="line-548">            <span class="n">modules</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">resnet</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove the FC layer</span>
</span><span id="line-549">            <span class="n">resnet_feature_extractor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)</span>
</span><span id="line-550">            <span class="n">resnet_feature_extractor</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</span><span id="line-551">            
</span><span id="line-552">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"embedding image data using ResNet50"</span><span class="p">)</span>
</span><span id="line-553">            <span class="n">feature_embeddings_list</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-554">       
</span><span id="line-555">            <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">data_loader</span><span class="p">):</span>
</span><span id="line-556">                <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
</span><span id="line-557">                    <span class="n">feature_embeddings</span> <span class="o">=</span> <span class="n">resnet_feature_extractor</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="line-558">                <span class="n">feature_embeddings</span> <span class="o">=</span> <span class="n">feature_embeddings</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">feature_embeddings</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</span><span id="line-559">    
</span><span id="line-560">                <span class="n">feature_embeddings_list</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">feature_embeddings</span><span class="p">)</span>
</span><span id="line-561">    
</span><span id="line-562">            <span class="n">col_name_core</span> <span class="o">=</span> <span class="n">image_url_col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">'_'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="line-563">            <span class="n">image_col_embedded_name</span> <span class="o">=</span> <span class="s1">'_'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_name_core</span> <span class="o">+</span> <span class="p">[</span><span class="s1">'emb'</span><span class="p">])</span>
</span><span id="line-564">            
</span><span id="line-565">            <span class="c1"># only important if embedd_n_images not -1 --&gt; not all images get embedded</span>
</span><span id="line-566">            <span class="n">feature_embeddings_list_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_embeddings_list</span><span class="p">)</span>
</span><span id="line-567">            <span class="n">all_listings_n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">)</span>
</span><span id="line-568">            <span class="n">diff</span> <span class="o">=</span> <span class="n">all_listings_n</span> <span class="o">-</span> <span class="n">feature_embeddings_list_n</span>
</span><span id="line-569">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">diff</span><span class="p">):</span>
</span><span id="line-570">                <span class="n">feature_embeddings_list</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span> 
</span><span id="line-571">                
</span><span id="line-572">    
</span><span id="line-573">            <span class="n">valid_feature_embeddings_list</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">feature_embeddings_list</span><span class="p">)[:</span><span class="n">feature_embeddings_list_n</span><span class="p">]</span>
</span><span id="line-574">            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">no_access_indices</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="line-575">                <span class="k">del</span> <span class="n">valid_feature_embeddings_list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span id="line-576">    
</span><span id="line-577">            <span class="n">valid_feature_embeddings_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">valid_feature_embeddings_list</span><span class="p">)</span>
</span><span id="line-578">            <span class="n">mean_embedding</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">valid_feature_embeddings_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-579">            
</span><span id="line-580">            <span class="k">for</span> <span class="n">no_access_index</span> <span class="ow">in</span> <span class="n">no_access_indices</span><span class="p">:</span>
</span><span id="line-581">                <span class="n">feature_embeddings_list</span><span class="p">[</span><span class="n">no_access_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_embedding</span>
</span><span id="line-582">    
</span><span id="line-583">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="n">image_col_embedded_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_embeddings_list</span>
</span><span id="line-584">            
</span><span id="line-585">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"image embedding done"</span><span class="p">)</span>
</span><span id="line-586">    
</span><span id="line-587">    <span class="k">def</span><span class="w"> </span><span class="nf">save_all_cities_listings_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
</span><span id="line-588">                                         <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">"single_city_listing.csv"</span><span class="p">,</span> 
</span><span id="line-589">                                         <span class="n">saving_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span>  <span class="s1">'preprocessed_data'</span><span class="p">,</span>
</span><span id="line-590">                                         <span class="n">single_data_frames</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-591">        
</span><span id="line-592">        <span class="bp">self</span><span class="o">.</span><span class="n">saving_dir</span> <span class="o">=</span> <span class="n">saving_dir</span>
</span><span id="line-593">
</span><span id="line-594">        <span class="k">if</span> <span class="n">single_data_frames</span><span class="p">:</span>
</span><span id="line-595">            <span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="s2">"city"</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</span><span id="line-596">            <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
</span><span id="line-597">                <span class="n">city_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="s2">"city"</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">]</span>
</span><span id="line-598">                <span class="n">city_dir</span> <span class="o">=</span> <span class="n">saving_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">"/</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">"</span>
</span><span id="line-599">                
</span><span id="line-600">                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">city_dir</span><span class="p">):</span>
</span><span id="line-601">                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">city_dir</span><span class="p">)</span>
</span><span id="line-602">                <span class="n">file_path</span> <span class="o">=</span> <span class="n">city_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">file_name</span> 
</span><span id="line-603">                
</span><span id="line-604">                <span class="n">city_listings</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="line-605">                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> listings saved to path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-606">        <span class="k">else</span><span class="p">:</span>
</span><span id="line-607">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">saving_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">file_name</span> 
</span><span id="line-608">            <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
</span><span id="line-609">            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">"all cities listings saved to path: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-610">
</span><span id="line-611">    <span class="k">def</span><span class="w"> </span><span class="nf">_read_preprocessed_listings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
</span><span id="line-612">        
</span><span id="line-613">        <span class="n">cities_subdirectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_data_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_data_dir</span><span class="p">,</span> <span class="n">d</span><span class="p">))]</span>
</span><span id="line-614">
</span><span id="line-615">        
</span><span id="line-616">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span><span class="p">))</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">cities_subdirectories</span><span class="p">):</span>
</span><span id="line-617">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"not all cities in need to be processed are in given read directory"</span><span class="p">)</span>
</span><span id="line-618">
</span><span id="line-619">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_all_cities</span><span class="p">:</span>
</span><span id="line-620">            <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span> <span class="o">=</span> <span class="n">cities_subdirectories</span>
</span><span id="line-621">        <span class="bp">self</span><span class="o">.</span><span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cities_to_process</span>
</span><span id="line-622">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="line-623">
</span><span id="line-624">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span><span class="p">:</span>
</span><span id="line-625">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"collecting data for city: </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</span><span id="line-626">            <span class="n">city_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessed_data_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2">"</span>
</span><span id="line-627">            <span class="n">city_dir_content</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">city_dir</span><span class="p">)</span>
</span><span id="line-628">            
</span><span id="line-629">            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">city_dir_content</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"there must exist only one single listing for city </span><span class="si">{</span><span class="n">city</span><span class="si">}</span><span class="s2"> in directory </span><span class="si">{</span><span class="n">city_dir</span><span class="si">}</span><span class="s2">"</span>
</span><span id="line-630">            <span class="n">city_file</span> <span class="o">=</span> <span class="n">city_dir_content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="line-631">            <span class="n">file_path</span> <span class="o">=</span> <span class="n">city_dir</span> <span class="o">+</span> <span class="s1">'/'</span> <span class="o">+</span> <span class="n">file_name</span> 
</span><span id="line-632">            
</span><span id="line-633">            <span class="n">city_listings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="line-634">            <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">city_listings</span><span class="p">)</span>
</span><span id="line-635">            
</span><span id="line-636">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_cities_listings</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="line-637">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"reading preprocessed cities from directoy done"</span><span class="p">)</span>
</span><span id="line-638">        <span class="k">return</span> <span class="n">all_cities_listings</span>
</span><span id="line-639">    
</span><span id="line-640">    <span class="k">def</span><span class="w"> </span><span class="nf">local_currency_to_usd_conversion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="line-641"><span class="w">        </span><span class="sd">"""</span>
</span><span id="line-642"><span class="sd">            Changes local currency to USD for specified cities in all_cities_listings dataframe</span>
</span><span id="line-643"><span class="sd">        """</span>
</span><span id="line-644">        <span class="n">cities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cities</span>
</span><span id="line-645">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span>
</span><span id="line-646">
</span><span id="line-647">        <span class="c1"># every cities currency should be mapped to USD via removing USD sign from string and converting the number to float then multiplying by the exchange rate</span>
</span><span id="line-648">        <span class="c1"># for 'berlin', "barcelona", "istanbul", "london", "oslo"</span>
</span><span id="line-649">        <span class="n">exchange_rates</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-650">            <span class="s2">"berlin"</span><span class="p">:</span> <span class="mf">1.05</span><span class="p">,</span> <span class="c1"># EUR -&gt; USD</span>
</span><span id="line-651">            <span class="s2">"barcelona"</span><span class="p">:</span> <span class="mf">1.05</span><span class="p">,</span> <span class="c1"># EUR -&gt; USD</span>
</span><span id="line-652">            <span class="s2">"istanbul"</span><span class="p">:</span> <span class="mf">0.026</span><span class="p">,</span> <span class="c1"># TRY -&gt; USD</span>
</span><span id="line-653">            <span class="s2">"london"</span><span class="p">:</span> <span class="mf">1.26</span><span class="p">,</span> <span class="c1"># GBP -&gt; USD</span>
</span><span id="line-654">            <span class="s2">"oslo"</span><span class="p">:</span> <span class="mf">0.09</span><span class="p">,</span> <span class="c1"># NOK -&gt; USD</span>
</span><span id="line-655">            <span class="s2">"los_angeles"</span><span class="p">:</span> <span class="mf">1.0</span> <span class="c1"># USD -&gt; USD</span>
</span><span id="line-656">        <span class="p">}</span>
</span><span id="line-657">
</span><span id="line-658">        <span class="c1"># price is stored in all_cities_listings["price"] as string with currency sign</span>
</span><span id="line-659">        <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="n">cities</span><span class="p">:</span>
</span><span id="line-660">            <span class="n">exchange_rate</span> <span class="o">=</span> <span class="n">exchange_rates</span><span class="p">[</span><span class="n">city</span><span class="p">]</span>
</span><span id="line-661">            <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="s2">"city"</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cities_listings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">all_cities_listings</span><span class="p">[</span><span class="s2">"city"</span><span class="p">]</span> <span class="o">==</span> <span class="n">city</span><span class="p">,</span> <span class="s2">"price"</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">"$"</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">","</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span> <span class="o">*</span> <span class="n">exchange_rate</span><span class="p">))</span>
</span><span id="line-662">
</span><span id="line-663">        <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span>
</span><span id="line-664">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"local currency to USD conversion done"</span><span class="p">)</span>
</span><span id="line-665">
</span><span id="line-666">    <span class="k">def</span><span class="w"> </span><span class="nf">categorical_to_one_hot_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
</span><span id="line-667">                                        <span class="n">include_city_column</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-668">        
</span><span id="line-669">        <span class="n">binary_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'host_is_superhost'</span><span class="p">,</span> <span class="s1">'host_has_profile_pic'</span><span class="p">,</span> <span class="s1">'host_identity_verified'</span><span class="p">,</span> <span class="s1">'has_availability'</span><span class="p">,</span> <span class="s1">'instant_bookable'</span><span class="p">]</span>
</span><span id="line-670">        <span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'host_response_time'</span><span class="p">,</span> <span class="s1">'neighbourhood_cleansed'</span><span class="p">,</span> <span class="s1">'property_type'</span><span class="p">,</span> <span class="s1">'room_type'</span><span class="p">]</span>
</span><span id="line-671">
</span><span id="line-672">        <span class="k">if</span> <span class="n">include_city_column</span><span class="p">:</span>
</span><span id="line-673">            <span class="n">categorical_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">'city'</span><span class="p">)</span>
</span><span id="line-674">
</span><span id="line-675">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span>
</span><span id="line-676">
</span><span id="line-677">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">all_cities_listings</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">binary_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="line-678">        <span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">all_cities_listings</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="line-679">
</span><span id="line-680">        <span class="bp">self</span><span class="o">.</span><span class="n">all_cities_listings</span> <span class="o">=</span> <span class="n">all_cities_listings</span>
</span><span id="line-681">        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">"one hot encoding done"</span><span class="p">)</span>
</span><span id="line-682">        
</span><span id="line-683">            
</span><span id="line-684">
</span><span id="line-685">
</span><span id="line-686">
</span><span id="line-687">        
</span><span id="line-688">
</span><span id="line-689"><span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="line-690">    <span class="n">data_set</span> <span class="o">=</span> <span class="n">InsideAirbnbDataset</span><span class="p">(</span><span class="n">raw_data_dir</span><span class="o">=</span> <span class="s2">"/media/sn/Frieder_Data/Master_Machine_Learning/data"</span><span class="p">,</span>
</span><span id="line-691">            <span class="n">process_all_cities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="line-692">            <span class="n">cities_to_process</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"oslo"</span><span class="p">,</span> <span class="s2">"barcelona"</span><span class="p">,</span> <span class="s2">"berlin"</span><span class="p">,</span> <span class="s2">"london"</span><span class="p">,</span> <span class="s2">"istanbul"</span><span class="p">,</span> <span class="s2">"los_angeles"</span><span class="p">],</span>
</span><span id="line-693">            <span class="n">read_from_raw</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="line-694"><span class="o">&lt;&lt;&lt;&lt;&lt;&lt;&lt;</span> <span class="n">HEAD</span>
</span><span id="line-695">            <span class="n">preprocessed_data_dir</span> <span class="o">=</span> <span class="s1">'/home/sn/pCloudDrive/AirBnB_Daten/European_Cities/European_Cities_Preprocessed'</span><span class="p">)</span>
</span><span id="line-696">    
</span><span id="line-697"><span class="o">=======</span>
</span><span id="line-698">            <span class="n">preprocessed_data_dir</span> <span class="o">=</span> <span class="s1">'/media/sn/Frieder_Data/Master_Machine_Learning/data_preprocessed'</span><span class="p">)</span>
</span><span id="line-699">
</span><span id="line-700">    <span class="n">data_set</span><span class="o">.</span><span class="n">local_currency_to_usd_conversion</span><span class="p">()</span>
</span><span id="line-701"><span class="o">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span> <span class="mi">2</span><span class="n">d37061</span> <span class="p">(</span><span class="n">Final</span> <span class="n">version</span> <span class="n">of</span> <span class="n">the</span> <span class="n">preprocessing</span><span class="p">)</span>
</span><span id="line-702">    <span class="n">data_set</span><span class="o">.</span><span class="n">filter_listings_and_impute_nan</span><span class="p">()</span>
</span><span id="line-703">    <span class="n">data_set</span><span class="o">.</span><span class="n">categorical_to_one_hot_encoding</span><span class="p">(</span><span class="n">include_city_column</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="line-704">    <span class="n">data_set</span><span class="o">.</span><span class="n">local_currency_to_usd_conversion</span><span class="p">()</span>
</span><span id="line-705">    
</span><span id="line-706">
</span><span id="line-707">    <span class="n">data_set</span><span class="o">.</span><span class="n">download_images_and_save</span><span class="p">(</span>
</span><span id="line-708">                            <span class="n">saving_dir</span> <span class="o">=</span> <span class="s1">'/media/sn/Frieder_Data/Master_Machine_Learning/images'</span><span class="p">,</span>
</span><span id="line-709">                            <span class="n">process_n_images</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="line-710">    <span class="c1">#additional_features = ['host_picture_analysis', 'listing_picture_analysis', 'distance_to_city_center', 'average_review_length', 'review_sentiment', 'spelling_errors', 'aesthetic_score', ]</span>
</span><span id="line-711">    <span class="c1">#AddCustomFeatures(data = data_set.all_cities_listings, additional_features= additional_features)</span>
</span><span id="line-712">    <span class="n">data_set</span><span class="o">.</span><span class="n">save_all_cities_listings_to_file</span><span class="p">(</span><span class="n">saving_dir</span><span class="o">=</span><span class="s1">'/media/sn/Frieder_Data/Master_Machine_Learning/data_preprocessed'</span><span class="p">)</span>
</span><span id="line-713">
</span><span id="line-714">
</span><span id="line-715"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
</span><span id="line-716">    <span class="n">main</span><span class="p">()</span>
</span><span id="line-717">
</span><span id="line-718">    
</span><span id="line-719">
</span><span id="line-720">
</span><span id="line-721">
</span><span id="line-722">
</span><span id="line-723">
</span><span id="line-724">
</span><span id="line-725">
</span></code></pre></div>
</div>
</div>
</section>
</div></div>
</main>
</div>
</div><footer class="py-6 border-t border-border md:py-0">
<div class="container flex flex-col items-center justify-between gap-4 md:h-24 md:flex-row">
<div class="flex flex-col items-center gap-4 px-8 md:flex-row md:gap-2 md:px-0">
<p class="text-sm leading-loose text-center text-muted-foreground md:text-left">© 2025, Georg Tirpitz, Nils Klute, Matthis Nommensen, Frieder Wizgall Built with <a class="font-medium underline underline-offset-4" href="https://www.sphinx-doc.org" rel="noreferrer">Sphinx 8.2.1</a></p>
</div>
</div>
</footer>
</div>
<script src="_static/documentation_options.js?v=5929fcd5"></script>
<script src="_static/doctools.js?v=9bcbadda"></script>
<script src="_static/sphinx_highlight.js?v=dc90522c"></script>
<script defer="defer" src="_static/theme.js?v=073f68d9"></script>
</body>
</html>